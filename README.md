# identity-give-orchestration
Orchestration component of GIVE


## Microservices

The orchestration service consists of a set of microservices

 - oe - The orchestration service. (Only service that needs to know how many instances of itself there are.)
 - api - The api service provides the api interface for the application and is the only service that is externally exposed.
 - portal - A static file app serving the admin portal React app
 - sdk - A static file app serving javascript sdk file
 - events - The event service records flow event data in elasticsearch

#### Tasks ####

 - dbconfigs - this app is run as a cf task to create and initialize the postgres db and create redis service.
 - esconfigs - this app is run as a cf task to create and initialize elasticsearch.
 - manifest - this app is run as a cf task to update the postgres db with data about the available connectors.

#### Connectors ####
These microservices provides connectors that can be used in flows.

 - analytics
 - challenge
 - credential
 - fido
 - flow
 - functions
 - http
 - iovation
 - jumio
 - openid
 - totp
 - transunion
 - userpolicy
 - variables
 - webhook

## Deploying the Application

The github actions workflows are used to provision the services and deploy the applications.
 1. First the three services need to be provisioned and initialized. `run-dbconfigs` workflow initializes the postgres db and redis. `run-esconfigs` workflow initializes elasticsearch.
 2. All of the `deploy-` workflows and the `run-manifest` can be run concurrently to deploy the microservices comprising this application.

### Deploying Services Manually
This component depends on 3 services:
 - Redis: facilitates communication between microservices
 - PostgreSQL: stores json formatted configuration data for the system
 - Elasticsearch: logs events generated by flows

```
cf create-service aws-elasticache-redis redis-dev sk-redis
cf create-service aws-rds medium-psql sk-postgres
cf create-service aws-elasticsearch es-dev sk-elasticsearch
```

### Networking

The api, portal and sdk microservice need to be externally routable.

The http connector microservice need network access to any other http GIVE microservices deployed in the cloud environment it will be using for flows.

## Accessing Services

### Redis

Connecting to this Redis instance requires TLS. This is a [compile time](https://redis.io/topics/encryption) feature in Redis so it is necessary to compile the Redis cli client. The other option is to use a proxy such as [stunnel](https://www.stunnel.org/).

```
cf connect-to-service -no-client sk-api sk-redis
```
```
redis-cli -h localhost -p <port> -a <password> --tls
```

### ElasticSearch

Connecting to the cloud.gov Elasticsearch instances requires sending aws v4 singed headers. A utility such as [awscurl](https://github.com/okigan/awscurl) can be used to send signed requests rest requests to the elasticsearch api.

```
cf ssh -T -L 443:<elasticsearch hostname>:443 sk-events
```
```
awscurl --region <region> --service es --access_key <access key> --secret_key <secret> -X GET 'https://<elasticsearch hostname>/_cat/indices?v'
```
It is necessary to add a host file entry for the Elasticsearch hostname in order for the signatures to be calculated correctly.
```
127.0.0.1 ....es.amazonaws.com
```

### Postgres

ssh tunnel or using the cf connect-to-service plugin

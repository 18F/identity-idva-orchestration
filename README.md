# identity-give-orchestration
Orchestration component of GIVE


## Microservices

The orchestration service consists of a set of microservices

 - oe - The orchestration service. (Only service that needs to know how many instances of itself there are.)
 - api - The api service provides the api interface for the application and is the only service that is exteranlly exposed.
 - portal - A static file app serving the admin portal React app
 - sdk - A static file app serving javascript sdk file
 - event - The event service recordes flow event data in elasticsearch

#### Tasks ####

 - manifest - this app is run as a cf task to update the postgres db with data about the available connectors.

#### Connectors ####
These micrservices provides connectors that can be used in flows.

http, challenge, crendentail, fido, flow, functions, iovation,jumio,openid, totp, transunion,userpolicy,variables.


## Deploying Services
This component depends on 3 services:
 - Redis: facilitates comunication between microservices
 - PostgreSQL: stores json formated configuration data for the system
 - Elasticsearch: logs events generated by flows

```
cf create-service aws-elasticache-redis redis-dev sk-redis
cf create-service aws-rds medium-psql sk-postgres
cf create-service aws-elasticsearch es-dev sk-elasticsearch
```

## Accessing Services

### Redis

Connecting to this redis instance requires tls. This is a [compile time](https://redis.io/topics/encryption) feature in redis so it is nessary to compile the redis cli client. The other option is to use a proxy such as [stunnel](https://www.stunnel.org/).

```
cf connect-to-service -no-client sk-api sk-redis
```
```
redis-cli -h localhost -p <port> -a <password> --tls
```

### ElasticSearch

Connecting to the cloud.gov Elasticsearch instances requires sending aws v4 singed headers. A utility such as [awscurl](https://github.com/okigan/awscurl) can be used to send signed requests rest requests to the elasticsearch api.

```
cf ssh -T -L 443:<elasticsearch hostname>:443 sk-events
```
```
awscurl --region <region> --service es --access_key <access key> --secret_key <secret> -X GET 'https://<elasticsearch hostname>/_cat/indices?v'
```
It is nessary to add a host file entry for the elasticsearch hostname in order for the signautures to be calculated correclty.
```
127.0.0.1 ....es.amazonaws.com
```

### Postgres

ssh tunnel or using the cf connect-to-service plugin